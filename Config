#!/bin/sh
#
# Configuration script for X4
#
# Basic construct created by Andromeda
#
#######################################################

HOMEDIR="${HOME}"
ISNUM="^[0-9]+$"

# Variables we need to send to configure
INSTALLDIR="${HOME}/x4"
MAXCONNS=4096
DEBUGMODE=n

# Were any of the values changed?
CHG_INSTALLDIR="n"
CHG_MAXCONNS="n"
CHG_DEBUGMODE="n"

MAXCONNS=`ulimit -Hn`
if test x"$MAXCONNS" = xunlimited; then
    MAXCONNS=`ulimit -Sn`
fi

exists() {
    if [ -f $1 -o -d $1 -o -p $1 -o -c $1 -o -b $1 ] ; then
        return 0
    else
        return 1
    fi
}

load_cache() {
    if [ -f ./config.cache -a -r ./config.cache -a ] ; then
        echo "Using data from config.cache."
        echo ""
        ./config.cache
        CAN_INSTALL = "yes"
    else
        CAN_INSTALL = "no"
    fi
}

build_install() {
    B_INSTALL_DIR=""
    B_MAXCONNS=""
    B_DEBUGMODE=""
    B_INCLUDE=""
    B_LIBS=""

    if [ "$INSTALLDIR" != "" ] ; then
        B_INSTALL_DIR="--prefix=$INSTALLDIR"
    fi

    if [ "$MAXCONNS" != "" ] ; then
        B_MAXCONNS="--with-maxcon=$MAXCONNS"
    fi

    if [ "$DEBUGMODE" != "n" ] ; then
        B_DEBUGMODE="--enable-debug"
    fi
}

ok=0
echo ""

####
echo "What directory should we use for X4?"
while [ "${ok}" -eq 0 ] ; do
    echo "[${INSTALLDIR}] "
    if read INPUT ; then : ; else echo "" ; exit 1 ; fi
    if [ ! "${INPUT}" ] ; then
        break
    fi
    if [ "$INPUT" != "$INSTALLDIR" ] ; then
        CHG_INSTALLDIR="y"
    fi
    /* How do we validate the path here? if valid set ok=1 and INSTALLDIR=$INPUT */
done

ok=0
echo ""

####
echo "How many connections should we allow?"
while [ "${ok}" -eq 0 ] ; do
    echo "[${MAXCONNS}] "
    if read INPUT ; then : ; else echo "" ; exit 1 ; fi
    if [ ! "${INPUT}" ] ; then
        break
    fi

    if [ "${INPUT}" ] ; then
        if [[ "$INPUT" =~ $ISNUM && "$INPUT" -gt 100 && "$INPUT" -lt "$MAXCONNS" ]] ; then
            if [ "$INPUT" != "$MAXCONNS" ] ; then
                CHG_MAXCONNS="y"
                MAXCONNS=$INPUT
            fi
            break
        else
            echo "Invalid input. Max connections must be a valid number and between 100 and $MAXCONNS"
        fi
    fi
done

ok=0
echo ""

####
echo "Should we enable debug code in X4?"
while [ "${ok}" -eq 0 ] ; do
    echo "[n] "
    if read INPUT ; then : ; else echo "" ; exit 1 ; fi
    if [ ! "${INPUT}" ] ; then
        INPUT=$DEBUGMODE
        break
    fi
    if [ "$INPUT" != "$DEBUGMODE" ] ; then
        CHG_DEBUGMODE="y"
    fi
    /* NEED to validate $INPUT is either yes, y, no or n, if it is then set DEBUGMODE=$INPUT and set ok=1 */
done

####
export B_INSTALLDIR $INPUT
echo ""

####

echo "Preparing to install..."
cat <<EOT >./config.cache
INSTALLDIR = "$B_INSTALL_DIR
EOT
echo ""
echo "Install Directory: ${INSTALLDIR} (Changed: ${CHG_INSTALLDIR})"
echo "Max Connections: ${MAXCONNS} (Changed: ${CHG_MAXCONNS})"
echo "Debug Mode: ${DEBUGMODE} (Changed: ${CHG_DEBUGMODE})"
echo ""
echo "Configure stage complete. Please proceed with make to continue your installation."

build_install
